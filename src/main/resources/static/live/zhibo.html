<!doctype html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="Generator" content="">
    <meta name="Author" content="">
    <meta name="Keywords" content="">
    <meta name="Description" content="">
    <meta name="viewport"
        content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />

    <style>
        .bg {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-image: url(./images/mask.png);
            background-size: 100% auto;
            background-position: 0 100%;
            background-repeat: no-repeat;
            z-index: 22
        }
    </style>
    <link rel="stylesheet" type="text/css" media="all" href="./css/style.css">
    <link rel="Shortcut Icon" href="./images/favicon.ico" />
    <script src="./js/jquery.min.js" type="text/javascript"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.5.0.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(function () {
            var $_GET = (function () {
                var url = window.document.location.href.toString();
                var u = url.split("?");
                if (typeof (u[1]) == "string") {
                    u = u[1].split("&");
                    var get = {};
                    for (var i in u) {
                        var j = u[i].split("=");
                        get[j[0]] = j[1];
                    }
                    return get;
                } else {
                    return {};
                }
            })();
            var state = $_GET['state'];
            var code = $_GET['code'];
            if (state == '' || state == undefined) {
                alert('无效的链接地址！');
                WeixinJSBridge.call('closeWindow');
                return false;
            } else {
                if (code == '' || code == null || code == undefined) {
                    var appid = 'wxbf553fc8992a2e86';
                    var redirect_uri = encodeURIComponent('http://tmanager.houaihome.com/live/zhibo.html');
                    var url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=" + appid +
                        "&redirect_uri=" +
                        redirect_uri + "&response_type=code&scope=snsapi_userinfo&state=" + state +
                        "#wechat_redirect";
                    window.location.replace(url);
                    return false;
                }
            }
            document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
                // 通过下面这个API隐藏右上角按钮
                WeixinJSBridge.call('hideOptionMenu');
            });
            pushHistory();

            function pushHistory() {
                var state = {
                    title: "",
                    url: ""
                };
                window.history.pushState(state, "", "");
            }
            window.addEventListener("popstate", function (e) {
                WeixinJSBridge.call('closeWindow');
                return false;
            }, false);
            var u = navigator.userAgent;
            if (u.match(/MicroMessenger/i) != 'MicroMessenger') {
                window.location.href =
                    "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxbf553fc8992a2e86&redirect_uri=http%3A%2F%2Ftmanager.houaihome.com";
                return false;
            }
            if (u.indexOf('Android') > -1 || u.indexOf('Linux') > -1) {
                var device = 'http://android.myapp.com/myapp/detail.htm?apkName=com.zjst.houai&ADTAG=mobile'
            } else if (u.indexOf('iPhone') > -1) {
                var device = 'https://itunes.apple.com/cn/app/zhong-jing-sheng-tian/id1288452365?mt=8'
            } else if (u.indexOf('Windows Phone') > -1) {
                var device = 'javascript:alert("不支持的系统！")';
            } else {
                var device = 'javascript:alert("不支持的系统！")';
            }
            $('.dl a').attr('href', device);
            var api = 'http://tmanager.houaihome.com/courseExt/web/list';
            var server_course = 'http://image.houaihome.com/yy/cms/';

            //http://tmanager.houaihome.com/live/
            var url = window.location.href.split('#')[0];
            var _title;
            _openid = sessionStorage.getItem('openid');
            if (_openid == '' || _openid == null || _openid == undefined) {
                arr_info = {
                    action: 'getInfo',
                    state: '',
                    code: code
                };
                $.post("http://tmanager.houaihome.com/wechat/auth", arr_info, function (data) {
                    if (data == 0) {
                        console.log('获取用户信息失败！');
                        console.log(data);
                        window.location.href = 'http://tmanager.houaihome.com/live/zhibo.html?id=' + id;
                        return false;
                    } else {
                        $('.content').attr('data-open-id', data.data.openId);
                        sessionStorage.setItem("openid", data.data.openId);
                        topage(data.data.openId);
                    }
                }, "json");
            } else {
                $('.content').attr('data-open-id', _openid);
                topage(_openid);
            }
            var ht = document.documentElement.clientHeight;
            $('.popupimg').css('max-height', ht);
            var view = sessionStorage.getItem('view');

            function _change() {
                sessionStorage.setItem("view", "1");
                $('.bg').animate({
                    marginTop: "-240%"
                }, 2048);
                //enable_scroll();
            }
            $.ajax({
                type: "post",
                dataType: "json",
                url: "http://tmanager.houaihome.com/wechat/sign",
                data: {
                    url: url
                },
                success: function (data) {
                    setTimeout(function () {
                        function get_title() {
                            if (_title == '' || _title == null || _title == undefined) {
                                _title = sessionStorage.getItem('title');
                            } else {
                                if (_title == '' || _title == null || _title == undefined) {
                                    _title = $('.block h3').html();
                                } else {
                                    clearInterval(_get_title);
                                }
                            }
                        }
                        var _get_title = setInterval(get_title, 50);
                        //微信注入权限接口
                        wx.config({
                            debug: false,
                            appId: data.data.appId,
                            timestamp: data.data.timestamp,
                            nonceStr: data.data.nonceStr,
                            signature: data.data.signature,
                            jsApiList: [
                                'onMenuShareAppMessage',
                                'onMenuShareTimeline'
                            ]
                        });
                        wx.ready(function () {
                            wx.onMenuShareAppMessage({
                                title: _title, // 分享标题
                                desc: '点击链接进入课程',
                                imgUrl: 'http://tmanager.houaihome.com/live/images/logo_share.png',
                                link: 'http://tmanager.houaihome.com/live/zhibo.html?state=' +
            state,
            type: 'link'
            });
            wx.onMenuShareTimeline({
            title: _title, // 分享标题
            desc: '点击链接进入课程', // 分享描述
            imgUrl: 'http://tmanager.houaihome.com/live/images/logo_share.png',
            link: 'http://tmanager.houaihome.com/live/zhibo.html?state=' +
            state,
            type: 'link'
            });

            wx.checkJsApi({
            jsApiList: [
            'onMenuShareAppMessage',
            'onMenuShareTimeline'
            ],
            success: function (data) {
            //alert(res.errMsg);
            WeixinJSBridge.call(
            'showOptionMenu');
            }
            });
            });
            wx.error(function (data) {
            alert('错误');
            });
            }, 300);
            },
            error: function () {
            alert('网络错误！');
            }
            });

            function topage(_openid) {
            var arr_api = {
            courseId: state,
            openId: _openid
            }
            $.ajax({
            url: api,
            type: 'POST',
            data: arr_api,
            async: false,
            cache: false,
            dataType: "json",
            timeout: 50000,
            beforeSend: function () {},
            success: function (data) {
            if (data.recode == '0') {
            if (data.data !== '' && data.data !== 'notExist' && data.data !==
            null) {
            $('.block h3').html(data.data.course);
            _title = data.data.course;
            sessionStorage.setItem("title", data.data.course);
            $('title').html(data.data.course);
            var _content = data.data.courseExt;
            var avatar = './images/logo_new.png';
            //var int_first = 1;
            $.each(_content, function (i, n) {
            var _img_url;
            var _ado_url;
            if (n.courseExtImgUrl == undefined) {} else {
            _img_url = n.courseExtImgUrl.substr(0, 4);
            }
            if (_img_url == 'http') {
            var this_img_url = n
            .courseExtImgUrl;
            } else {
            var this_img_url = server_course + n
            .courseExtImgUrl;
            }
            if (n.courseExtAudio == undefined) {} else {
            _ado_url = n.courseExtAudio.substr(0, 4);
            }
            if (_ado_url == 'http') {
            var this_ado_url = n.courseExtAudio;
            } else {
            var this_ado_url = server_course + n
            .courseExtAudio;
            }
            var block = n.courseExtAudioTimes * 2;
            if (n.courseExtType == '1') {
            $('.content').append(
            '<div  class="msg mw"><div class="h"><img src="' +
                                            avatar +
                                            '" /></div><div class="fl"><h3 class="n">' +
            n.courseExtNickname +
            '</h3><div class="c w">' + n
            .courseExtWords +
            '<span class="t"></span></div></div></div>'
            );
            } else if (n.courseExtType == '2') {
            $('.content').append(
            '<div  class="msg ma"><div class="h"><img src="' +
                                            avatar +
                                            '" /></div><div class="fl"><h3 class="n">' +
            n.courseExtNickname +
            '</h3><div class="c a"><audio id="html_audio_'+i+'" sourceindex="'+i+'"><source id="html_source_'+i+'" src="' +
                                            this_ado_url +
                                            '" type="audio/mp3"></audio><div class="audio-left"><img src="./images/sd.png" class="audioPlayer" /></div><div class="audio-right"><span class="audio_times">' +
                                            n.courseExtAudioTimes +
                                            ' "</span><span class="time_block" style="width:' +
                                            block +
                                            'px"></span></div><span class="t"></span></div><span class="r p"></span></div></div>'
            );
            } else if (n.courseExtType == '3') {
            $('.content').append(
            '<div class="msg mi "><div class="h"><img src="' +
                                            avatar +
                                            '" /></div><div class="fl"><h3 class="n">' +
            n.courseExtNickname +
            '</h3><div class="c i"><a href="javascript:void(0);" rel="popuprel"  title="" class="popup"><img class="" src="' +
                                            this_img_url +
                                            '" ></a><span class="t"></span></div></div></div>'
            );
            } else {}
            });
            } else {
            alert('直播已关闭！');
            WeixinJSBridge.call('closeWindow');
            return false;
            }
            } else {
            console.log('出错了');
            }
            },
            complete: function (data) {
            //console.log(view);
            var view = sessionStorage.getItem('view');
            if (view == null || view == '' || view == undefined) {
            setTimeout(_change, 666);
            } else if (_openid == '1') {
            $('.bg').hide();
            } else {
            $('.bg').hide();
            }
            },
            error: function (data) {
            console.log('出错了!');
            }
            }, "json");
            }
            });
            </script>
            <title>直播分享</title>
            </head>

            <body>
            <div class="mask">
                <div class="bd"></div>
                </div>
                <div class="bg"></div>
                <div class="header">
                <div class="block">
                <h3>&nbsp;</h3>
        </div>
        <div class="dl">
            <a href="http://down.houaihome.com/download/"></a>
            <audio id="g_audio">
            	<source id="g_source" src="" type="audio/mp3">
            </audio>
        </div>
    </div>
    <div class="content" data-open-id=''>
    </div>
    <div class="bottom"></div>
    <div class="popupbox" id="popuprel">
        <img class="popupimg" src="">
    </div>
    <div id="fade"></div>

    <script type="text/javascript">
    	var g_audio, g_audio_obj, g_audio_id;
    	var mobile_type = "", total = 0;
    	//页面加载
    	$(function(){
    		//获取手机类型，同步mobile_type字段，ios/android
    		getMobileType();
    		initAudio();
    		//音频播放点击事件
    		$('.content').on('click', '.ma .a', function () {
    			var audios= $('.content').find('audio');
				total = audios.length;
    			//初始化音频
    			audio = $(this).find('audio');
                playAudio(audio);
            });
            //图片点击事件
            $('.content').on('click', 'a.popup', function () {
                var popupid = $(this).attr('rel');
                var img = $(this).find('img').attr('src');
                $('.popupimg').attr("src", img);
                $('#' + popupid).fadeIn();
                $('#fade').css({
                    'filter': 'alpha(opacity=70)'
                }).fadeIn(100);
                var popuptopmargin = ($('#' + popupid).height()) / 2;
                var popupleftmargin = ($('#' + popupid).width()) / 2;
                $('#' + popupid).css({
                    'margin-top': -popuptopmargin,
                    'margin-left': -popupleftmargin
                });
            });
            //关闭图片事件
            $('#fade, #popuprel').click(function () {
                $('#fade , #popuprel , #popuprel2 , #popuprel3').fadeOut(100);
                return false;
            });
    	});
    	//=================================================================================================
    	function getMobileType(){
    		var u = navigator.userAgent;
            if (u.indexOf('Android') > -1 || u.indexOf('Linux') > -1) {
                var device = 'http://android.myapp.com/myapp/detail.htm?apkName=com.zjst.houai&ADTAG=mobile'
                mobile_type="android";
            } else if (u.indexOf('iPhone') > -1) {
                var device = 'https://itunes.apple.com/cn/app/zhong-jing-sheng-tian/id1288452365?mt=8'
                mobile_type="ios";
            } else if (u.indexOf('Windows Phone') > -1) {
                var device = 'javascript:alert("不支持的系统！")';
            } else {
                var device = 'javascript:alert("不支持的系统！")';
            }
    	}
    	//初始化音频方法
    	function initAudio() {
			g_audio = $("#g_audio");
			g_audio_obj = g_audio.get(0)
			//=======================绑定监听事件
            g_audio_obj.addEventListener("waiting", audio_waiting);
            //播放事件监听
            g_audio_obj.addEventListener("playing", audio_playing);
            //播放完成事件监听
            g_audio_obj.addEventListener('ended', audio_ended, false);
        }
    	//监听事件方法==========================================================================
    	function audio_waiting(e) {
            $('#'+g_audio_id).parent().find('.audioPlayer').attr('src', './images/load.gif');
            $('#'+g_audio_id).parent().parent().find('.p').removeClass('r');
        }
    	function audio_playing(e) {
            $('#'+g_audio_id).parent().find('.audioPlayer').attr('src', './images/sd.gif');
            $('#'+g_audio_id).parent().parent().find('.p').removeClass('r');
        }
        function audio_ended(e) {
            $('#'+g_audio_id).currentTime = 0;
            $('#'+g_audio_id).parent().find('.audioPlayer').attr('src', './images/sd.png');
            //自动播放下一条
            
            autoNext();
        }
        //播放音频方法
    	function playAudio(current_audio){
            //设置播放音频，scroll位置
			var this_offset = current_audio.parent().parent().parent().offset().top;
            var this_scroll = $(window).scrollTop();
            var this_ht = $(window).height()
            if (this_scroll + this_ht < this_offset + 76) {
                var _offset = this_offset + 246 - this_ht;
                $('body,html').animate({
                    scrollTop: _offset
                }, 300);
            } else if (this_scroll > this_offset) {
                console.log('在屏幕上方');
            }
            //设置除当前播放audio外，其它audio时间归零，更换图片
    		$('.content').find('audio').not(current_audio).each(function () {
	            $(this).parent().find('.audioPlayer').attr('src', './images/sd.png');
            });
			//========================================================================
			if(!g_audio_obj.paused){
				$('#'+g_audio_id).parent().find('.audioPlayer').attr('src', './images/sd.png');
				g_audio_obj.pause();
				g_audio_obj.currentTime = 0;
			}
			if(current_audio.attr("id")==g_audio_id){
				g_audio_id = "";
			}else{
				//设置播放音频src
				g_audio_id = current_audio.attr("id");
				var sourceindex = current_audio.attr("sourceindex");
				// alert("a: "+current_audio.get(0).currentSrc);
				// alert("b: "+$('#html_source_'+sourceindex).attr("src"));
	    		//$('#g_source').attr("src", current_audio.get(0).currentSrc);
	    		$('#g_source').attr("src", $('#html_source_'+sourceindex).attr("src"));
				g_audio_obj.load();
				g_audio_obj.play();
				// if(mobile_type=="ios"){
	   //          	WeixinJSBridge.invoke('getNetworkType', {}, function (e) {
	   //          		g_audio_obj.play();
	   //             });
	   //          }else if(mobile_type=="android"){
	   //          	g_audio_obj.play();
	   //          }else{
	   //          	g_audio_obj.play();
	   //          }
			}
			
    	}
    	//传入当前播放的音频，自动检测播放下一条
    	function autoNext(){
    		var current_audio = $('#'+g_audio_id)
    		// audio = current_audio.get(0);
    		
			var current_index = $('.content').find('audio').index(current_audio); //当前序号
			if(current_index < total){
				var next_audio = $('.content').find('audio').eq(current_index+1);
                playAudio(next_audio);
			}
    	}
    </script>
</body>

</html>
